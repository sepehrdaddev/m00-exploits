/*
 *  m00-upx-phucker.c v.1.0 by m00 Security
 *
 * UPX is a very powerful dos/com, dos/exe, linux/386,
 * linux/elf386, linux/sh386, ps1/exe, win32/pe packer.
 * But there is a one problem: packed with UPX binary
 * files could be easily decompressed useing "-d" option
 * (./upx -d <file>). Now it's in da past!
 * This tool makes packed with UPX linux/x86 ELF binaries
 * uncompressable by replacing UPX signatures with
 * random strings.
 * Tested only on the latest 1.90 UPX version, but it must
 * work on other versions..
 *
 * Thanx to wh and ech0
 * Greets to all m00sec@EFnet ppl
 *
 * -d4rkgr3y [d4rk@securitylab.ru] // m00.void.ru
 *
*/

/*
satan@evilbox 2.4.21-0.13mdk$ echo EXAMPLE
EXAMPLE
satan@evilbox 2.4.21-0.13mdk$ ls -l johntheripper
-rwxr-xr-x    1 satan    satan      171576 Feb 22 17:19 johntheripper*
satan@evilbox 2.4.21-0.13mdk$ ./upx -9 johntheripper
                     Ultimate Packer for eXecutables
         Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002
UPX 1.90         Markus F.X.J. Oberhumer & Laszlo Molnar        Nov 11th 2002

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
    171576 ->     63477   36.99%  linux/elf386   johntheripper

Packed 1 file.

WARNING: this is an unstable beta version - use for testing only! Really.
satan@evilbox 2.4.21-0.13mdk$ ls -l johntheripper
-rwxr-xr-x    1 satan    satan       63477 Feb 22 17:19 johntheripper*
satan@evilbox 2.4.21-0.13mdk$ ./m00-upx-fucker johntheripper johntheripper1
[~] m00-upx-phucker.c v.1.0 by m00 Security
[~] author: d4rkgr3y [d4rk@securitylab.ru] // m00.void.ru

[~] Input file: johntheripper
[~] Output file: johntheripper1
[~] Scanning...

[+] Complete
[~] 23 bytes replaced
satan@evilbox 2.4.21-0.13mdk$ ls -l johntheripper*
-rwxr-xr-x    1 satan    satan       63477 Feb 22 17:19 johntheripper*
-rwxr-xr-x    1 satan    satan       63477 Feb 22 17:28 johntheripper1*
satan@evilbox 2.4.21-0.13mdk$ ./upx -d johntheripper
                     Ultimate Packer for eXecutables
         Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002
UPX 1.90         Markus F.X.J. Oberhumer & Laszlo Molnar        Nov 11th 2002

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
    171576 <-     63477   36.99%  linux/elf386   johntheripper

Unpacked 1 file.

WARNING: this is an unstable beta version - use for testing only! Really.
satan@evilbox 2.4.21-0.13mdk$ ./upx -d johntheripper1
                     Ultimate Packer for eXecutables
         Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002
UPX 1.90         Markus F.X.J. Oberhumer & Laszlo Molnar        Nov 11th 2002

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
upx: johntheripper1: NotPackedException: not packed by UPX

Unpacked 0 files.

WARNING: this is an unstable beta version - use for testing only! Really.
satan@evilbox 2.4.21-0.13mdk$ ./johntheripper1
John the Ripper password cracker, version 1.6.36
Copyright (c) 1996-2003 by Solar Designer
Homepage: http://www.openwall.com/john/

Usage: ./johntheripper1 [OPTIONS] [PASSWORD-FILES]
--single                   "single crack" mode
--wordlist=FILE --stdin    wordlist mode, read words from FILE or stdin
--rules                    enable word mangling rules for wordlist mode
....
*/
/*
 make backup before useing )
*/

#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>

void usage(char *app);

int main(int argc, char *argv[])
{
	printf("[~] m00-upx-phucker.c v.1.0 by m00 Security\n");
	printf("[~] author: d4rkgr3y [d4rk@securitylab.ru] // m00.void.ru\n\n");

	if(argc < 3) usage(argv[0]);
	char *input = argv[1];
	char *output = argv[2];
	char * string = "\x55\x50\x58";
	char charz[55] = "1234567890abcdefghigklmnopqrstuvwxyz!?@#$%^&*()_+-=~`'";
	char buf[3];
	int len = strlen(string);
	int verbose=0;
	int i, got, C=0;
	int bytesC=0;
	int changed=0;
	int ch;
	FILE *in;
	FILE *out;

	if(argv[3]) verbose = 1;
	got = 0;

	if(((in = fopen(input, "r"))==NULL) || ((out = fopen(output, "a"))==NULL)) {
		printf("[-] Error openning file\n");
		exit(-1);
	}
	printf("[~] Input file: %s\n[~] Output file: %s\n[~] Scanning...\n",input,output);
	while ((ch = getc(in)) != EOF) {
		if(verbose) {
			if(C==0x00) printf("| ");
			C++;
			if(ch<0x10) printf("0");
			printf("%x ",ch);
			if(C==0x10) {
				C = 0x00;
				printf("|");
				if(changed) {
					printf(" <= 0x555058 > replaced with 0x%x%x%x..\n",buf[0],buf[1],buf[2]);
					changed=0;
					memset(&buf,'\x00',3);
				} else printf("\n");
			}
		}
		if (got == 1) {
			++i;
			if (ch == string[i]) {
				srand(rand() % getpid());
				putwc(charz[rand() % 56],out);
				buf[i]=charz[rand() % 56];
				bytesC++;
			} else if(i == len) {
				got = 0;
				changed = 1;
				srand(rand() % getpid());
				putwc(charz[rand() % 56],out);
				buf[i]=charz[rand() % 56];
				bytesC++;
			} else {
				got = 0;
				fprintf(out,"U");
			}
		}
		if(got != 1) {
			if (ch == string[0]) {
				got = 1; i = 0;
			} else {
				memset(&ch+1,'\x00',1);
				putc(ch,out);
			}
		}
	}
	chmod(argv[2],0755);
	printf("\n[+] Complete\n[~] %d bytes replaced\n",bytesC);
	fclose(in);
	fclose(out);
	return 0;
}

void usage(char *app) {
	fprintf(stderr,"[-] usage: %s <input-file> <output-file> [(v)erbose]\n",app);
	exit(-1);
}
